<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Glow Artisans - Lighting Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Brand Palette & Base Styles */
      :root {
        --charcoal: #1a1a1a;
        --gold: #d4af37;
        --winter-white: #f5f5f5;
      }
      body {
        font-family: "Lato", sans-serif;
        background-color: var(--winter-white);
        color: var(--charcoal);
      }
      .font-serif-display {
        font-family: "Playfair Display", serif;
      }
      .control-panel {
        background-color: #ffffff;
      }
      .canvas-workspace {
        background-color: #e5e7eb;
        background-image: linear-gradient(
            45deg,
            #f9fafb 8.33%,
            transparent 8.33%,
            transparent 50%,
            #f9fafb 50%,
            #f9fafb 58.33%,
            transparent 58.33%,
            transparent 100%
          ),
          linear-gradient(
            -45deg,
            #f9fafb 8.33%,
            transparent 8.33%,
            transparent 50%,
            #f9fafb 50%,
            #f9fafb 58.33%,
            transparent 58.33%,
            transparent 100%
          );
        background-size: 24px 24px;
      }
      .btn {
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .btn-gold {
        background-color: var(--gold);
        color: var(--charcoal);
        font-weight: 700;
      }
      .btn-gold:hover {
        background-color: #c49d2b;
      }
      .btn-secondary {
        background-color: #e5e7eb;
        color: var(--charcoal);
      }
      .btn-secondary:hover {
        background-color: #d1d5db;
      }
      .tool-btn {
        border: 2px solid #d1d5db;
      }
      .tool-btn.active {
        border-color: var(--gold);
        background-color: #fefce8;
      }
      /* Custom Slider Styles */
      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
      }
      input[type="range"]:focus {
        outline: none;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 8px;
        cursor: pointer;
        background: #e5e7eb;
        border-radius: 5px;
      }
      input[type="range"]::-webkit-slider-thumb {
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: var(--gold);
        cursor: pointer;
        -webkit-appearance: none;
        margin-top: -6px;
      }
      input[type="range"]::-moz-range-track {
        width: 100%;
        height: 8px;
        cursor: pointer;
        background: #e5e7eb;
        border-radius: 5px;
      }
      input[type="range"]::-moz-range-thumb {
        height: 20px;
        width: 20px;
        border-radius: 50%;
        background: var(--gold);
        cursor: pointer;
      }
      /* Spinner */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--gold);
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="antialiased h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-charcoal text-white py-3 px-6 shadow-md z-10">
      <div class="flex justify-between items-center">
        <h1 class="text-2xl font-serif-display text-gold">
          Glow Artisans
          <span class="text-white font-sans text-lg font-normal"
            >- Lighting Designer</span
          >
        </h1>
        <button
          id="downloadBtn"
          class="btn btn-gold py-2 px-4 rounded-md text-sm"
        >
          Download Design
        </button>
      </div>
    </header>

    <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
      <!-- Left Column (Toolbox) -->
      <aside
        class="w-full md:w-80 lg:w-96 bg-white p-6 border-r border-gray-200 overflow-y-auto"
      >
        <div class="space-y-6">
          <!-- 1. Image Upload -->
          <div>
            <label
              for="imageLoader"
              class="btn btn-gold w-full text-center py-3 rounded-lg cursor-pointer"
            >
              Upload House Photo
            </label>
            <input
              type="file"
              id="imageLoader"
              class="hidden"
              accept="image/jpeg, image/png"
            />
          </div>

          <hr />

          <!-- 2. Light Styles -->
          <div>
            <h3 class="font-bold text-lg mb-3">Light Style</h3>
            <div class="grid grid-cols-2 gap-2">
              <button class="tool-btn active py-3 rounded-lg" data-type="c9">
                C9 Bulbs
              </button>
              <button class="tool-btn py-3 rounded-lg" data-type="mini">
                Mini Lights
              </button>
            </div>
          </div>

          <!-- 3. Light Controls -->
          <div>
            <h3 class="font-bold text-lg mb-3">Controls</h3>
            <div class="space-y-4">
              <div>
                <label for="bulbSize" class="block mb-1"
                  >Bulb Size: <span id="bulbSizeValue">5</span>px</label
                >
                <input type="range" id="bulbSize" min="2" max="15" value="5" />
              </div>
              <div>
                <label for="bulbSpacing" class="block mb-1"
                  >Bulb Spacing: <span id="bulbSpacingValue">20</span>px</label
                >
                <input
                  type="range"
                  id="bulbSpacing"
                  min="5"
                  max="50"
                  value="20"
                />
              </div>
            </div>
          </div>

          <hr />

          <!-- 4. Essential Tools -->
          <div>
            <h3 class="font-bold text-lg mb-3">Tools</h3>
            <div class="grid grid-cols-2 gap-2">
              <button id="undoBtn" class="btn btn-secondary py-3 rounded-lg">
                Undo
              </button>
              <button id="clearBtn" class="btn btn-secondary py-3 rounded-lg">
                Clear
              </button>
            </div>
          </div>

          <hr />

          <!-- 5. NEW: Gemini API Feature -->
          <div>
            <h3 class="font-bold text-lg mb-3">âœ¨ AI Proposal Assistant</h3>
            <button
              id="generateDescBtn"
              class="btn btn-gold w-full py-3 rounded-lg"
            >
              Generate Description
            </button>
            <div id="ai-output-container" class="mt-4 hidden">
              <div id="ai-spinner" class="spinner mx-auto my-4 hidden"></div>
              <div id="ai-result-box" class="relative">
                <textarea
                  id="aiDescription"
                  rows="6"
                  class="w-full p-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-gold bg-gray-50"
                  readonly
                ></textarea>
                <button
                  id="copyBtn"
                  class="absolute top-2 right-2 p-1 bg-gray-200 hover:bg-gray-300 rounded-md"
                >
                  <svg
                    class="w-5 h-5 text-gray-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
                    ></path>
                  </svg>
                </button>
              </div>
              <p
                id="copy-success"
                class="text-sm text-center text-green-600 mt-1 hidden"
              >
                Copied to clipboard!
              </p>
            </div>
          </div>
        </div>
      </aside>

      <!-- Right Column (Canvas) -->
      <main
        class="flex-grow canvas-workspace flex items-center justify-center p-4 overflow-auto"
      >
        <div id="canvas-container" class="relative shadow-lg">
          <canvas id="lightingCanvas" class="block"></canvas>
          <div
            id="placeholder"
            class="absolute inset-0 flex items-center justify-center pointer-events-none"
          >
            <p
              class="text-gray-500 text-2xl font-serif-display p-8 bg-white/75 rounded-lg"
            >
              Upload a photo to begin designing
            </p>
          </div>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Get references to all DOM elements
        const imageLoader = document.getElementById("imageLoader");
        const canvas = document.getElementById("lightingCanvas");
        const ctx = canvas.getContext("2d");
        const placeholder = document.getElementById("placeholder");

        const lightTypeButtons = document.querySelectorAll(
          ".tool-btn[data-type]"
        );
        const bulbSizeSlider = document.getElementById("bulbSize");
        const bulbSpacingSlider = document.getElementById("bulbSpacing");
        const bulbSizeValue = document.getElementById("bulbSizeValue");
        const bulbSpacingValue = document.getElementById("bulbSpacingValue");

        const undoBtn = document.getElementById("undoBtn");
        const clearBtn = document.getElementById("clearBtn");
        const downloadBtn = document.getElementById("downloadBtn");

        // NEW: Gemini AI elements
        const generateDescBtn = document.getElementById("generateDescBtn");
        const aiOutputContainer = document.getElementById(
          "ai-output-container"
        );
        const aiSpinner = document.getElementById("ai-spinner");
        const aiDescription = document.getElementById("aiDescription");
        const copyBtn = document.getElementById("copyBtn");
        const copySuccess = document.getElementById("copy-success");

        // Application state variables
        let backgroundImage = null;
        let history = [];
        let startPoint = null;

        // Tool settings
        let settings = {
          type: "c9",
          size: 5,
          spacing: 20,
          color: "rgba(212, 175, 55, 1)", // var(--gold)
          glowColor: "rgba(212, 175, 55, 0.7)",
        };

        // --- Event Listeners ---

        imageLoader.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            backgroundImage = new Image();
            backgroundImage.onload = () => {
              canvas.width = backgroundImage.width;
              canvas.height = backgroundImage.height;
              history = [];
              startPoint = null;
              redrawCanvas();
              placeholder.style.display = "none";
            };
            backgroundImage.src = event.target.result;
          };
          reader.readAsDataURL(file);
        });

        lightTypeButtons.forEach((button) => {
          button.addEventListener("click", () => {
            lightTypeButtons.forEach((btn) => btn.classList.remove("active"));
            button.classList.add("active");
            settings.type = button.dataset.type;
          });
        });

        bulbSizeSlider.addEventListener("input", (e) => {
          settings.size = parseInt(e.target.value);
          bulbSizeValue.textContent = settings.size;
        });
        bulbSpacingSlider.addEventListener("input", (e) => {
          settings.spacing = parseInt(e.target.value);
          bulbSpacingValue.textContent = settings.spacing;
        });

        canvas.addEventListener("click", (e) => {
          if (!backgroundImage) return;

          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;
          const x = (e.clientX - rect.left) * scaleX;
          const y = (e.clientY - rect.top) * scaleY;

          if (!startPoint) {
            startPoint = { x, y };
            redrawCanvas(); // Redraw to clear previous marker if any
            // Draw a temporary marker for the start point
            ctx.fillStyle = "rgba(255, 0, 0, 0.7)";
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, Math.PI * 2);
            ctx.fill();
          } else {
            const endPoint = { x, y };
            const line = {
              start: startPoint,
              end: endPoint,
              ...settings,
            };
            history.push(line);
            startPoint = null;
            redrawCanvas();
          }
        });

        undoBtn.addEventListener("click", () => {
          if (history.length > 0) {
            history.pop();
            startPoint = null;
            redrawCanvas();
          }
        });

        clearBtn.addEventListener("click", () => {
          if (confirm("Are you sure you want to clear all lights?")) {
            history = [];
            startPoint = null;
            redrawCanvas();
          }
        });

        downloadBtn.addEventListener("click", () => {
          if (!backgroundImage) {
            alert("Please upload an image first.");
            return;
          }
          const link = document.createElement("a");
          link.download = "GlowArtisans-Design.jpg";
          link.href = canvas.toDataURL("image/jpeg", 1.0);
          link.click();
        });

        document.addEventListener("keydown", (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === "z") {
            e.preventDefault();
            undoBtn.click();
          }
        });

        // --- Gemini API Functionality ---
        generateDescBtn.addEventListener("click", async () => {
          if (!backgroundImage) {
            alert("Please upload and design an image first.");
            return;
          }

          aiOutputContainer.classList.remove("hidden");
          aiSpinner.classList.remove("hidden");
          aiDescription.value = "";

          const imageData = canvas.toDataURL("image/jpeg").split(",")[1];
          const textPrompt = `You are a professional lighting designer for the luxury brand 'Glow Artisans.' Based on the provided image, write a short, elegant, and professional description of this holiday lighting design. Focus on the style, key features (like rooflines or trees), and the overall feeling it creates. This will be used in a client proposal.`;

          try {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
              contents: [
                {
                  parts: [
                    { text: textPrompt },
                    {
                      inline_data: { mime_type: "image/jpeg", data: imageData },
                    },
                  ],
                },
              ],
            };

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });

            if (!response.ok)
              throw new Error(`API Error: ${response.statusText}`);

            const result = await response.json();
            const candidate = result.candidates?.[0];
            if (candidate && candidate.content?.parts?.[0]?.text) {
              aiDescription.value = candidate.content.parts[0].text;
            } else {
              throw new Error("Invalid response from API.");
            }
          } catch (error) {
            console.error("Gemini API Error:", error);
            aiDescription.value =
              "Sorry, we couldn't generate a description at this time. Please try again.";
          } finally {
            aiSpinner.classList.add("hidden");
          }
        });

        copyBtn.addEventListener("click", () => {
          aiDescription.select();
          try {
            document.execCommand("copy");
            copySuccess.classList.remove("hidden");
            setTimeout(() => copySuccess.classList.add("hidden"), 2000);
          } catch (err) {
            console.error("Failed to copy text: ", err);
          }
        });

        // --- Core Drawing Functions ---
        function redrawCanvas() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (backgroundImage) {
            ctx.drawImage(backgroundImage, 0, 0);
          }
          history.forEach(drawLightsOnPath);
        }

        function drawLightsOnPath(path) {
          const { start, end, type, size, spacing, color, glowColor } = path;

          const dx = end.x - start.x;
          const dy = end.y - start.y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const angle = Math.atan2(dy, dx);

          // Start drawing from the first point
          const numBulbs = Math.floor(distance / spacing) + 1;

          for (let i = 0; i < numBulbs; i++) {
            const x = start.x + Math.cos(angle) * i * spacing;
            const y = start.y + Math.sin(angle) * i * spacing;

            ctx.shadowBlur = size * 2;
            ctx.shadowColor = glowColor;
            ctx.fillStyle = color;

            ctx.beginPath();
            ctx.arc(x, y, size / 2, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.shadowBlur = 0;
        }
      });
    </script>
  </body>
</html>
